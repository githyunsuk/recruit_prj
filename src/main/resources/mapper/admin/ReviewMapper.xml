<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.sist.user.mapper.ReviewMapper">
	
	<select id="selectSearchReviews" parameterType="kr.co.sist.admin.SearchDTO" resultType="kr.co.sist.user.dto.ReviewDTO">
  SELECT * FROM (
    SELECT a.*, ROWNUM rnum FROM (
      SELECT review_seq AS reviewSeq,
             corp_no AS corpNo,
             email,
             rating,
             summary,
             pros,
             cons,
             created_at AS createdAt  <!-- 오타 수정 -->
      FROM review
      <where>
        <if test="keyword != null and keyword.trim() != ''">
          <choose>
            <when test="type == 'email'">
              AND email LIKE '%' || #{keyword} || '%'
            </when>
            <when test="type == 'corp_no'">
              AND TO_CHAR(corp_no) LIKE '%' || #{keyword} || '%'
            </when>
            <when test="type == 'rating'">
              AND TO_CHAR(rating) LIKE '%' || #{keyword} || '%'
            </when>
            <when test="type == 'summary'">
              AND summary LIKE '%' || #{keyword} || '%'
            </when>
            <otherwise>
              AND (
                email LIKE '%' || #{keyword} || '%'
                OR TO_CHAR(corp_no) LIKE '%' || #{keyword} || '%'
                OR TO_CHAR(rating) LIKE '%' || #{keyword} || '%'
                OR summary LIKE '%' || #{keyword} || '%'
                OR pros LIKE '%' || #{keyword} || '%'
                OR cons LIKE '%' || #{keyword} || '%'
              )
            </otherwise>
          </choose>
        </if>
      </where>
      ORDER BY
      <choose>
        <when test="sortField != null and sortField.trim() != ''">
          ${sortField} ${sortOrder}
        </when>
        <otherwise>
          created_at DESC
        </otherwise>
      </choose>
    ) a
    WHERE ROWNUM &lt;= #{offset} + #{size}
  )
  WHERE rnum &gt; #{offset}
</select>

<select id="countSearch" parameterType="kr.co.sist.admin.SearchDTO" resultType="int">
  SELECT COUNT(*) FROM review
  <where>
    <if test="keyword != null and keyword.trim() != ''">
      <choose>
        <when test="type == 'email'">
          AND email LIKE '%' || #{keyword} || '%'
        </when>
        <when test="type == 'corp_no'">
          AND TO_CHAR(corp_no) LIKE '%' || #{keyword} || '%'
        </when>
        <otherwise>
          AND (
            email LIKE '%' || #{keyword} || '%'
            OR TO_CHAR(corp_no) LIKE '%' || #{keyword} || '%'
            OR TO_CHAR(rating) LIKE '%' || #{keyword} || '%'
            OR summary LIKE '%' || #{keyword} || '%'
            OR pros LIKE '%' || #{keyword} || '%'
            OR cons LIKE '%' || #{keyword} || '%'
          )
        </otherwise>
      </choose>
    </if>
    
    <!-- rating 별도 필터 -->
  <if test="rating != null and rating != '전체'">
    AND TO_CHAR(rating) = TO_CHAR(#{rating})
  </if>
  </where>
</select>


</mapper>