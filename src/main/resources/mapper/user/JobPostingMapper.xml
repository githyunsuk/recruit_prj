<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.user.mapper.JobPostingMapper">

<resultMap id="jobPostResultMap" type="kr.co.sist.user.dto.JobPostDTO">
    <id property="jobPostingSeq" column="jobPostingSeq"/>
    <result property="postingTitle" column="postingTitle"/>
    <result property="postingDetail" column="postingDetail"/>
    <result property="expLevel" column="expLevel"/>
    <result property="recruitCnt" column="recruitCnt"/>
    <result property="salary" column="salary"/>
    <result property="postingStartDt" column="postingStartDt"/>
    <result property="postingEndDt" column="postingEndDt"/>
    <result property="workday" column="workday"/>
    <result property="workStartTime" column="workStartTime"/>
    <result property="workEndTime" column="workEndTime"/>
    <result property="viewCnt" column="viewCnt"/>
    <result property="zipcode" column="zipcode"/>
    <result property="roadAddress" column="roadAddress"/>
    <result property="detailAddress" column="detailAddress"/>
    <result property="corpNm" column="corpNm"/>
    <result property="corpInfo" column="corpInfo"/>
    <result property="corpUrl" column="corpUrl"/>
    <result property="positionName" column="positionName"/>
    <result property="positionSeq" column="positionSeq"/>
    <result property="stackName" column="stackName"/>
</resultMap>

<!-- 전체 공고 조회 -->
<select id="selectAllJobPostings" resultMap="jobPostResultMap">
   SELECT
    jp.job_posting_seq AS jobPostingSeq,
    jp.posting_title AS postingTitle,
    jp.posting_detail AS postingDetail,
    jp.exp_level AS expLevel,
    jp.recruit_cnt AS recruitCnt,
    jp.salary AS salary,
    jp.posting_start_dt AS postingStartDt,
    jp.posting_end_dt AS postingEndDt,
    jp.workday AS workday,
    jp.work_start_time AS workStartTime,
    jp.work_end_time AS workEndTime,
    jp.view_cnt AS viewCnt,
    jp.zipcode AS zipcode,
    jp.road_address AS roadAddress,
    jp.detail_address AS detailAddress,
    jp.position_seq AS positionSeq,
    c.corp_nm AS corpNm,
    c.corp_info AS corpInfo,
    c.corp_url AS corpUrl,
    pc.position_name AS positionName,
    COALESCE(ts.stack_name, '기술 스택 없음') AS stackName  -- null일 경우 기본값 처리
FROM JOB_POSTING jp
JOIN COMPANY c ON jp.corp_no = c.corp_no
JOIN POSITION_CODE pc ON jp.position_seq = pc.position_seq
LEFT JOIN JOB_POSTING_TECH_STACK jpts ON jp.job_posting_seq = jpts.job_posting_seq
LEFT JOIN TECH_STACK ts ON jpts.tech_stack_seq = ts.tech_stack_seq
ORDER BY jp.job_posting_seq, ts.stack_name
</select>

<!-- 특정 jobPostingSeq에 해당하는 공고 조회 -->
<select id="selectJobPostingsBySeq" parameterType="Integer" resultMap="jobPostResultMap">
    SELECT
        jp.job_posting_seq AS jobPostingSeq,
        jp.posting_title AS postingTitle,
        jp.posting_detail AS postingDetail,
        jp.exp_level AS expLevel,
        jp.recruit_cnt AS recruitCnt,
        jp.salary AS salary,
        jp.posting_start_dt AS postingStartDt,
        jp.posting_end_dt AS postingEndDt,
        jp.workday AS workday,
        jp.work_start_time AS workStartTime,
        jp.work_end_time AS workEndTime,
        jp.view_cnt AS viewCnt,
        jp.zipcode AS zipcode,
        jp.road_address AS roadAddress,
        jp.detail_address AS detailAddress,
        jp.position_seq AS positionSeq,
        c.corp_nm AS corpNm,
        c.corp_info AS corpInfo,
        c.corp_url AS corpUrl,
        pc.position_name AS positionName,
        ts.stack_name AS stackName
    FROM JOB_POSTING jp
    JOIN COMPANY c ON jp.corp_no = c.corp_no
    JOIN POSITION_CODE pc ON jp.position_seq = pc.position_seq
    LEFT JOIN JOB_POSTING_TECH_STACK jpts ON jp.job_posting_seq = jpts.job_posting_seq
    LEFT JOIN TECH_STACK ts ON jpts.tech_stack_seq = ts.tech_stack_seq
    WHERE jp.job_posting_seq = #{jobPostingSeq}
    ORDER BY ts.stack_name
</select>

<!-- 특정 공고에 대한 기술 스택만 조회 -->
<select id="selectTechStacksByJobPostingSeq" parameterType="Integer" resultType="string">
    SELECT ts.stack_name
    FROM TECH_STACK ts
    JOIN JOB_POSTING_TECH_STACK jpts ON ts.tech_stack_seq = jpts.tech_stack_seq
    WHERE jpts.job_posting_seq = #{jobPostingSeq}
    ORDER BY ts.stack_name
</select>

<!-- 조회수 -->
<update id="updateJobPostingViewCount" parameterType="map">
    UPDATE JOB_POSTING
    SET view_cnt = #{viewCount}
    WHERE job_posting_seq = #{jobPostingSeq}
</update>

<!-- 인기순 공고 8개 조회 (조회수 기준) -->
<select id="getPopularJobPostings" resultMap="jobPostResultMap">
    SELECT 
    jp.job_posting_seq AS jobPostingSeq,
    jp.posting_title AS postingTitle,
    jp.posting_detail AS postingDetail,
    jp.exp_level AS expLevel,
    jp.recruit_cnt AS recruitCnt,
    jp.salary AS salary,
    jp.posting_start_dt AS postingStartDt,
    jp.posting_end_dt AS postingEndDt,
    jp.workday AS workday,
    jp.work_start_time AS workStartTime,
    jp.work_end_time AS workEndTime,
    jp.view_cnt AS viewCnt,
    jp.zipcode AS zipcode,
    jp.road_address AS roadAddress,
    jp.detail_address AS detailAddress,
    jp.position_seq AS positionSeq,
    c.corp_nm AS corpNm,
    c.corp_info AS corpInfo,
    c.corp_url AS corpUrl,
    pc.position_name AS positionName,
    COALESCE(ts.stack_name, '기술 스택 없음') AS stackName  -- null일 경우 기본값 처리
FROM JOB_POSTING jp
JOIN COMPANY c ON jp.corp_no = c.corp_no
JOIN POSITION_CODE pc ON jp.position_seq = pc.position_seq
LEFT JOIN JOB_POSTING_TECH_STACK jpts ON jp.job_posting_seq = jpts.job_posting_seq
LEFT JOIN TECH_STACK ts ON jpts.tech_stack_seq = ts.tech_stack_seq
WHERE jp.posting_end_dt >= SYSDATE
ORDER BY jp.view_cnt DESC
FETCH FIRST 8 ROWS ONLY
</select>


</mapper>