<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>민기 인력</title>
<th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
<link rel="stylesheet" th:href="@{/user/css/header.css}" />
<link rel="stylesheet" th:href="@{/user/css/footer.css}" />
<link rel="stylesheet" th:href="@{/user/jobPosting/css/main_page.css}"/>
<link rel="stylesheet" th:href="@{/user/jobPosting/css/job_posting_detail.css}"/>
<style type="text/css">
</style>     
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    const $modal = $('#applyModal');
    let selectedResumeId = null;

    // 모달 열기
    $('#applyBtn').on('click', function (e) {
        e.preventDefault();
        $modal.show().addClass('show');
        fetchUserResumes();
        $('#attachmentList').empty(); // 첨부파일 리스트 초기화
    });

    // 모달 닫기
    function closeModal() {
        $modal.hide().removeClass('show');
        selectedResumeId = null;
        $('.resume-item').removeClass('selected');
        $('#attachmentList').empty();
    }

    $('#closeBtn, #cancelBtn').on('click', function () {
        closeModal();
    });

    $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && $modal.hasClass('show')) {
            closeModal();
        }
    });

    // 이력서 불러오기
    function fetchUserResumes() {
        $.ajax({
            url: '/user/resume',
            method: 'GET',
            success: function (resumes) {
                renderResumeList(resumes);
            },
            error: function () {
                alert('이력서 불러오기에 실패했습니다.');
            }
        });
    }

    function renderResumeList(resumes) {
        const $container = $('.resume-section');
        $container.empty();

        if (!resumes || resumes.length === 0) {
            $container.append('<p>등록된 이력서가 없습니다.</p>');
            return;
        }

        resumes.forEach((resume, index) => {
            const resumeId = resume.resumeSeq;

            const resumeItem = $(`
                <div class="resume-item">
                    <input type="radio" id="resume_${resumeId}" name="selectedResume" value="${resumeId}" class="resume-radio">
                    <label for="resume_${resumeId}" class="resume-label">
                        <div class="resume-icon"></div>
                        <div class="resume-info">
                            <div class="resume-title">${resume.title}</div>
                            <div class="resume-meta">${resume.createdAt || ''} 등록</div>
                        </div>
                    </label>
                </div>
            `);

            resumeItem.find('input').on('change', function () {
                selectedResumeId = parseInt($(this).val(), 10);
                $('.resume-item').removeClass('selected');
                resumeItem.addClass('selected');
                renderAttachmentList(resume.attachments || []);
            });

            $container.append(resumeItem);
        });

        if (resumes.length > 0) {
            selectedResumeId = parseInt(resumes[0].resumeSeq, 10);
            $(`#resume_${selectedResumeId}`).prop('checked', true);
            $(`#resume_${selectedResumeId}`).closest('.resume-item').addClass('selected');
            renderAttachmentList(resumes[0].attachments || []);
        }
    }

    function renderAttachmentList(attachments) {
        const $attachmentContainer = $('#attachmentList');
        $attachmentContainer.empty();

        if (!attachments || attachments.length === 0) {
            $attachmentContainer.append('<p>첨부파일이 없습니다.</p>');
            return;
        }

        attachments.forEach(att => {
            const attItem = $(`
                <div class="attachment-item">
                    <a href="/attachment/download/${att.id}" target="_blank">${att.fileName}</a>
                </div>
            `);
            $attachmentContainer.append(attItem);
        });
    }

    // 지원하기 버튼 클릭
    $('#confirmBtn').on('click', function () {
        if (!selectedResumeId) {
            alert('이력서를 선택해주세요.');
            return;
        }

        const jobPostingSeq = parseInt($('#jobPostingSeq').val(), 10);
        if (!jobPostingSeq) {
            alert('잘못된 공고 정보입니다.');
            return;
        }

        $.ajax({
            url: '/apply',
            method: 'POST',
            data: {
                resumeSeq: selectedResumeId,
                jobPostingSeq: jobPostingSeq
            },
            success: function () {
                alert('지원 완료');
                closeModal();
            },
            error: function (xhr) {
                alert('지원 오류: ' + xhr.responseText);
            }
        });
    });
});

</script>

</head>
<body>
<header>
<div th:replace="~{fragments/header :: header}"></div>
</header>
<main>
     <div class="main-container" style="display: flex; gap: 30px;">
<div style="flex: 1;">

            <br>
            <h2 class="job_posting_title" th:text="${jDto.postingTitle}" style="font-weight: bold;"></h2>
            
            <br>
            <div class="stack">
                <h2 class="section-title" th:each="stack : ${jDto.techStacks}" th:text="${stack}">기술스택</h2>
            
            </div>

            <div class="job-section">
               <h2>주요내용</h2>
               <p th:text="${jDto.postingDetail}"></p>
            
            </div>

            <div class="job-info-box">
                <div>
                    <h2>경력</h2>
                  <p th:text="${jDto.expLevel}">경력</p>

                </div>
                <div>
                    <h2>학력</h2>
                    <p>무관</p>
                </div>
                <div>
                    <h2>마감일</h2>
                    <p th:text="${jDto.postingEndDt}">마감일</p>

                </div>
                <div>
                    <h2>근무지</h2>
                   <p th:text="${jDto.roadAddress}">근무주소</p>

                </div>
                <div>
                    <h2>평균 연봉</h2>
                    <p>3,000~4,500만원</p>
                </div>
                <div>
                    <h2>근무형태</h2>
                    <p th:text="${jDto.employType}">근무형태</p>
                </div>
            </div>

            <div class="company-intro">
                <h2 style="font-size: 30px; margin-bottom: 20px;"  th:utext="${jDto.corpInfo}"><strong>기업소개</strong></h2>
                <img src="" class="company-image" />
                <div class="company-description">
                    저희 테크노베이션은 혁신적인 기술과 창의적인 아이디어로 디지털 혁신을 이끌어가는 IT 기업입니다. 
                    2021년 설립 이후 지속적인 성장을 이어가고 있으며, 고객의 니즈를 정확히 파악하고 최적의 솔루션을 제공하기 위해 끊임없이 노력하고 있습니다.
                    <br><br>
                    직원들의 성장과 발전을 위한 다양한 프로그램을 운영하며, 자유롭고 수평적인 조직문화를 추구합니다. 
                    개발자들이 최고의 퍼포먼스를 발휘할 수 있도록 최신 개발 환경과 도구를 제공하고 있으며, 
                    지속적인 학습과 성장을 지원하는 교육 프로그램도 운영하고 있습니다.
                    <br><br>
                    함께 성장하며 더 나은 미래를 만들어갈 동료를 찾고 있습니다.
                </div>
            </div>
        </div>
    </div>

    <!-- 플로팅 사이드바 -->
    <div class="floating-sidebar">
        <div class="company-floating-card">
            <div class="company-logo-section">
                <div class="logo-placeholder">
                    <span>🏢</span>
                </div>
                <div class="company-title">
                    <h4 th:text="${jDto.corpNm}">기업이름</h4>
                    <span><a th:href="@{/user/job_posting/company_info}">기업정보 보기 &gt;</a></span>
                </div>
            </div>

            <div class="company-info-section">
                <div class="info-item">
                    <span class="label">업력</span>
                    <span class="value">5년차 (2021년 설립)</span>
                </div>
            </div>

            <button class="floating-apply-btn" id="applyBtn">지원하기</button>

            <div class="floating-actions">
                <button class="floating-action-btn" id="scrapBtn">
                    <span class="icon" id="heartIcon">🤍</span>
                    <span class="text">스크랩</span>
                </button>
            </div>
        </div>
    </div>

<!-- 모달창 -->
 <div id="applyModal" class="modal">
        <div class="modal-content">
        <input type="hidden" id="jobPostingSeq" th:value="${jDto.jobPostingSeq}" />
            <div class="modal-header">
                <h2>입사지원</h2>
                <span class="close-btn" id="closeBtn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="job-info">
                   <div class="job-info">
				    <div class="job-title" th:text="${jDto.postingTitle}">공고 제목</div>
				    <div class="job-company" th:text="${jDto.corpNm}">회사명</div>
                </div>

                <div class="section-title">통합 계정정보</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">이름</span>
                        <span class="info-value" th:text="${user != null ? user.name : '게스트'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">이메일</span>
                        <span class="info-value" th:text="${user != null ? user.email : '게스트'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">연락처</span>
                        <span class="info-value" th:text="${user != null ? user.phone : '게스트'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">출생년도</span>
                        <span class="info-value" th:text="${user != null && user.birth != null ? user.birth : '정보 없음'}"></span>
                    </div>
                </div>

                <div class="section-title">지원 이력서 <span class="required">●</span></div>
                <div class="resume-section">
                    <th:block th:each="resume, stat : ${resumes}">
                    <div class="resume-item">
                        <input type="radio"   th:id="'resume' + ${stat.index}" name="selectedResume" th:value="${resume.resumeSeq}" class="resume-radio" th:checked="${stat.index == 0}">
                        <label  th:for="'resume' + ${stat.index}" class="resume-label">
                            <div class="resume-icon"></div>
                            <div class="resume-info">
                                <div class="resume-title"  th:text="${resume.title}"></div>
                                <div class="resume-meta" th:text="|${resume.createdAt} 등록|"></div>
                            </div>
                        </label>
                    </div>
                    </th:block>
                </div>

               <div class="section-title">첨부 파일</div>
				<div id="attachmentList" class="attachment-list"></div>
           
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel-btn" id="cancelBtn">취소</button>
                <button class="modal-apply-btn" id="confirmBtn">지원하기</button>
            </div>
        </div>
    </div>
</div>
</main>
<footer>
<div th:replace="~{fragments/footer :: footer}"></div>
</footer>
</body>
</html>
