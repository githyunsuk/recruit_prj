<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>민기 인력</title>
<th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
<link rel="stylesheet" th:href="@{/user/css/header.css}" />
<link rel="stylesheet" th:href="@{/user/css/footer.css}" />
<link rel="stylesheet" th:href="@{/user/jobPosting/css/main_page.css}"/>
<link rel="stylesheet" th:href="@{/user/jobPosting/css/job_posting_detail.css}"/>
<style type="text/css">
</style>     
<script type="text/javascript">

	document.addEventListener('DOMContentLoaded', function() {
	    const applyBtn = document.getElementById('applyBtn');
	    const modal = document.getElementById('applyModal');
	    const closeBtn = document.getElementById('closeBtn');
	    const cancelBtn = document.getElementById('cancelBtn');
	    const confirmBtn = document.getElementById('confirmBtn');

	    // 요소 존재 확인 후 오류 방지
	    if (!applyBtn || !modal) {
	        console.error('필요한 요소를 찾을 수 없습니다:', {
	            applyBtn: !!applyBtn,
	            modal: !!modal
	        });
	        return;
	    }

	    // 페이지 로드 시 모달 강제 닫기
	    modal.style.display = 'none';
	    modal.classList.remove('show');

	    // 사용자 정보 (DB에서 가져올 데이터)
	    let userData = null;
	    let uploadedFiles = [];
	    let selectedResume = null;

	    // 모달 열기 - 오류 처리 개선
	    applyBtn.addEventListener('click', async (e) => {
	        e.preventDefault();
	        e.stopPropagation();
	        
	        try {
	            console.log('지원하기 버튼 클릭됨');
	            
	            // 모달 먼저 표시
	            modal.style.display = 'block';
	            modal.classList.add('show');
	            
	            // 사용자 정보 로드 (오류 발생 시에도 모달은 유지)
	            try {
	                await loadUserData();
	                
	                if (userData) {
	                    initResumeSelection();
	                    initFileUpload();
	                } else {
	                    // 사용자 정보가 없어도 기본값으로 모달 표시
	                    setDefaultUserData();
	                    initResumeSelection();
	                    initFileUpload();
	                }
	            } catch (error) {
	                console.error('사용자 정보 로드 오류:', error);
	                // 오류 발생 시 기본값 사용
	                setDefaultUserData();
	                initResumeSelection();
	                initFileUpload();
	            }
	            
	        } catch (error) {
	            console.error('모달 열기 중 오류:', error);
	            alert('오류가 발생했습니다: ' + error.message);
	        }
	    });

	
	    // 모달 닫기
	    function closeModal() {
	        if (modal) {
	            modal.style.display = 'none';
	            modal.classList.remove('show');
	        }
	        
	        // 파일 업로드 초기화
	        uploadedFiles = [];
	        const uploadedFilesContainer = document.getElementById('uploadedFiles');
	        if (uploadedFilesContainer) {
	            uploadedFilesContainer.innerHTML = '';
	        }
	        const fileInput = document.getElementById('fileInput');
	        if (fileInput) {
	            fileInput.value = '';
	        }
	        
	        // 이력서 선택 초기화
	        selectedResume = null;
	        
	        // 라디오 버튼 선택 해제
	        const resumeRadios = document.querySelectorAll('input[name="selectedResume"]');
	        resumeRadios.forEach(radio => {
	            radio.checked = false;
	        });
	        
	        // 선택 스타일 제거
	        const resumeItems = document.querySelectorAll('.resume-item');
	        resumeItems.forEach(item => {
	            item.classList.remove('selected');
	        });
	    }

	    // 이벤트 리스너들 - null 체크 추가
	    if (closeBtn) {
	        closeBtn.addEventListener('click', (e) => {
	            e.preventDefault();
	            e.stopPropagation();
	            closeModal();
	        });
	    }
	    
	    if (cancelBtn) {
	        cancelBtn.addEventListener('click', (e) => {
	            e.preventDefault();
	            e.stopPropagation();
	            closeModal();
	        });
	    }

	    // 모달 외부 클릭 시 닫기
	    modal.addEventListener('click', (e) => {
	        if (e.target === modal) {
	            e.preventDefault();
	            e.stopPropagation();
	            closeModal();
	        }
	    });

	    // ESC 키로 모달 닫기
	    document.addEventListener('keydown', (e) => {
	        if (e.key === 'Escape' && modal && modal.classList.contains('show')) {
	            e.preventDefault();
	            closeModal();
	        }
	    });

	    // 이력서 선택 관련 함수 - 오류 방지
	    function initResumeSelection() {
	        try {
	            const resumeRadios = document.querySelectorAll('input[name="selectedResume"]');
	            
	            // 첫 번째 이력서를 기본 선택으로 설정
	            if (userData && userData.resumes && userData.resumes.length > 0) {
	                selectedResume = userData.resumes[0].id;
	                const firstRadio = document.querySelector(`input[value="${selectedResume}"]`);
	                if (firstRadio) {
	                    firstRadio.checked = true;
	                }
	            }
	            
	            resumeRadios.forEach((radio) => {
	                radio.addEventListener('change', () => {
	                    selectedResume = radio.value;
	                    updateResumeSelection();
	                });
	            });
	            
	            // 초기 선택 상태 업데이트
	            updateResumeSelection();
	        } catch (error) {
	            console.error('이력서 선택 초기화 오류:', error);
	        }
	    }

	    function updateResumeSelection() {
	        try {
	            const resumeItems = document.querySelectorAll('.resume-item');
	            resumeItems.forEach((item) => {
	                const radio = item.querySelector('input[type="radio"]');
	                if (radio && radio.checked) {
	                    item.classList.add('selected');
	                } else {
	                    item.classList.remove('selected');
	                }
	            });
	        } catch (error) {
	            console.error('이력서 선택 업데이트 오류:', error);
	        }
	    }

	    // 파일 업로드 관련 함수 - 오류 방지
	    function initFileUpload() {
	        try {
	            const uploadArea = document.getElementById('uploadArea');
	            const fileInput = document.getElementById('fileInput');

	            if (!uploadArea || !fileInput) {
	                console.warn('파일 업로드 요소를 찾을 수 없습니다');
	                return;
	            }

	            // 파일 업로드 이벤트
	            uploadArea.addEventListener('click', () => {
	                fileInput.click();
	            });

	            uploadArea.addEventListener('dragover', (e) => {
	                e.preventDefault();
	                uploadArea.classList.add('dragover');
	            });

	            uploadArea.addEventListener('dragleave', () => {
	                uploadArea.classList.remove('dragover');
	            });

	            uploadArea.addEventListener('drop', (e) => {
	                e.preventDefault();
	                uploadArea.classList.remove('dragover');
	                const files = e.dataTransfer.files;
	                handleFiles(files);
	            });

	            fileInput.addEventListener('change', (e) => {
	                const files = e.target.files;
	                handleFiles(files);
	            });
	        } catch (error) {
	            console.error('파일 업로드 초기화 오류:', error);
	        }
	    }

	    function handleFiles(files) {
	        try {
	            Array.from(files).forEach(file => {
	                // 파일 크기 제한 (5MB)
	                if (file.size > 5 * 1024 * 1024) {
	                    alert('파일 크기는 5MB를 초과할 수 없습니다.');
	                    return;
	                }

	                // 중복 파일 체크
	                if (uploadedFiles.some(f => f.name === file.name)) {
	                    alert('이미 업로드된 파일입니다.');
	                    return;
	                }

	                uploadedFiles.push(file);
	                renderUploadedFiles();
	            });
	        } catch (error) {
	            console.error('파일 처리 오류:', error);
	        }
	    }

	    function renderUploadedFiles() {
	        try {
	            const uploadedFilesContainer = document.getElementById('uploadedFiles');
	            if (!uploadedFilesContainer) return;
	            
	            uploadedFilesContainer.innerHTML = '';
	            
	            uploadedFiles.forEach((file, index) => {
	                const fileDiv = document.createElement('div');
	                fileDiv.className = 'uploaded-file';
	                
	                const fileSize = formatFileSize(file.size);
	                const fileIcon = getFileIcon(file.name);
	                
	                fileDiv.innerHTML = `
	                    <div class="file-info">
	                        <span class="file-icon">${fileIcon}</span>
	                        <span class="file-name">${file.name}</span>
	                        <span class="file-size">${fileSize}</span>
	                    </div>
	                    <button class="remove-file" onclick="removeFile(${index})">×</button>
	                `;
	                
	                uploadedFilesContainer.appendChild(fileDiv);
	            });
	        } catch (error) {
	            console.error('파일 렌더링 오류:', error);
	        }
	    }

	    // 전역 함수로 선언
	    window.removeFile = function(index) {
	        try {
	            uploadedFiles.splice(index, 1);
	            renderUploadedFiles();
	        } catch (error) {
	            console.error('파일 삭제 오류:', error);
	        }
	    };

	    function formatFileSize(bytes) {
	        if (bytes === 0) return '0 Bytes';
	        const k = 1024;
	        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
	        const i = Math.floor(Math.log(bytes) / Math.log(k));
	        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	    }

	    function getFileIcon(filename) {
	        const ext = filename.split('.').pop().toLowerCase();
	        switch (ext) {
	            case 'pdf': return '📄';
	            case 'doc':
	            case 'docx': return '📝';
	            case 'txt': return '📄';
	            default: return '📎';
	        }
	    }

	    // 사용자 정보 불러오기 - 오류 처리 개선
	    async function loadUserData() {
	        try {
	            console.log('사용자 정보 로드 시작');
	            
	            
	            // 임시 데이터로 대체
	            await new Promise(resolve => setTimeout(resolve, 100)); // 로딩 시뮬레이션
	            setDefaultUserData();
	            
	            console.log('사용자 정보 로드 완료');
	            
	        } catch (error) {
	            console.error('사용자 정보 로드 중 오류 발생:', error);
	            throw error;
	        }
	    }

	    // 사용자 정보 UI 업데이트
	    function updateUserInfoUI() {
	        try {
	            if (!userData) return;
	            
	            // 사용자 이름 표시
	            const nameElement = document.querySelector('.info-value');
	            if (nameElement) {
	                nameElement.textContent = userData.name;
	            }
	            
	            // 이메일 표시
	            const emailElement = document.querySelectorAll('.info-value')[1];
	            if (emailElement) {
	                emailElement.textContent = userData.email;
	            }
	            
	            // 전화번호 표시
	            const phoneElement = document.querySelectorAll('.info-value')[2];
	            if (phoneElement) {
	                phoneElement.textContent = userData.phone;
	            }
	            
	            // 출생년도 표시
	            const birthYearElement = document.querySelectorAll('.info-value')[3];
	            if (birthYearElement) {
	                birthYearElement.textContent = userData.birthYear;
	            }
	            
	            // 이력서 목록 업데이트
	            updateResumeList();
	        } catch (error) {
	            console.error('사용자 정보 UI 업데이트 오류:', error);
	        }
	    }

	    // 이력서 목록 업데이트
	    function updateResumeList() {
	        try {
	            const resumeContainer = document.querySelector('.resume-section');
	            if (!resumeContainer || !userData.resumes) return;
	            
	            resumeContainer.innerHTML = '';
	            
	            userData.resumes.forEach((resume, index) => {
	                const resumeItem = document.createElement('div');
	                resumeItem.className = 'resume-item';
	                
	                const tagsHtml = resume.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
	                
	                resumeItem.innerHTML = `
	                    <input type="radio" id="resume_${resume.id}" name="selectedResume" value="${resume.id}" class="resume-radio">
	                    <label for="resume_${resume.id}" class="resume-label">
	                        <div class="resume-icon"></div>
	                        <div class="resume-info">
	                            <div class="resume-title">${resume.title}</div>
	                            <div class="resume-meta">${resume.registeredDate} 등록</div>
	                            <div class="resume-tags">${tagsHtml}</div>
	                        </div>
	                    </label>
	                `;
	                
	                resumeContainer.appendChild(resumeItem);
	            });
	        } catch (error) {
	            console.error('이력서 목록 업데이트 오류:', error);
	        }
	    }

	    // 지원 확인 - 오류 처리 개선
	    if (confirmBtn) {
	        confirmBtn.addEventListener('click', async (e) => {
	            e.preventDefault();
	            
	            if (confirmBtn.disabled) return;
	            
	            // 이력서 선택 확인
	            if (!selectedResume) {
	                alert('이력서를 선택해주세요.');
	                return;
	            }
	            
	            // 로딩 상태
	            confirmBtn.disabled = true;
	            const originalText = confirmBtn.innerHTML;
	            confirmBtn.innerHTML = '<span class="loading"></span>지원 중...';
	            
	            try {
	                // 실제 환경에서는 submitApplication() 함수 호출
	                // await submitApplication();
	                
	                // 테스트용 - 2초 대기
	                await new Promise(resolve => setTimeout(resolve, 2000));
	                
	                alert('지원이 완료되었습니다!');
	                closeModal();
	            } catch (error) {
	                console.error('지원 중 오류 발생:', error);
	                alert('지원 중 오류가 발생했습니다. 다시 시도해주세요.');
	            } finally {
	                confirmBtn.disabled = false;
	                confirmBtn.innerHTML = originalText;
	            }
	        });
	    }

	    // 스크랩 기능
	    const scrapBtn = document.getElementById('scrapBtn');
	    const heartIcon = document.getElementById('heartIcon');

	    if (scrapBtn && heartIcon) {
	        scrapBtn.addEventListener('click', function() {
	            try {
	                if (heartIcon.textContent === '🤍') {
	                    heartIcon.textContent = '❤️';
	                    heartIcon.classList.add('liked');
	                } else {
	                    heartIcon.textContent = '🤍';
	                    heartIcon.classList.remove('liked');
	                }
	            } catch (error) {
	                console.error('스크랩 기능 오류:', error);
	            }
	        });
	    }
	});
</script>
</head>
<body>
<header>
<div th:replace="~{fragments/header :: header}"></div>
</header>
<main>
     <div class="main-container" style="display: flex; gap: 30px;">
<div style="flex: 1;">

            <br>
            <h2 class="job_posting_title" th:text="${jDto.postingTitle}" style="font-weight: bold;"></h2>
            <br>
            <div class="stack">
                <h2 class="section-title" th:each="stack : ${jDto.techStacks}" th:text="${stack}">기술스택</h2>
            
            </div>

            <div class="job-section">
                <h3>주요업무</h3>
                <ul>
                    <li>웹 프론트엔드 개발 및 유지보수</li>
                    <li>사용자 인터페이스 설계 및 구현</li>
                    <li>백엔드 API 연동 및 데이터 처리</li>
                    <li>크로스 브라우징 및 반응형 웹 구현</li>
                    <li>성능 최적화 및 코드 리팩토링</li>
                </ul>
            </div>

            <div class="job-section">
                <h3>자격요건</h3>
                <ul>
                    <li>JavaScript / React framework 개발 가능하신 분</li>
                    <li>HTML/CSS 마크업 능력</li>
                    <li>Git 사용 경험</li>
                    <li>웹 표준 및 접근성에 대한 이해</li>
                    <li>팀워크와 커뮤니케이션 능력</li>
                </ul>
            </div>

            <div class="job-section">
                <h3>우대사항</h3>
                <ul>
                    <li>TypeScript 사용 경험자 우대</li>
                    <li>Vue.js 또는 Angular 경험자 우대</li>
                    <li>모바일 앱 개발 경험</li>
                    <li>UI/UX 디자인 이해도</li>
                </ul>
            </div>

            <div class="job-section">
                <h3>복지 및 혜택</h3>
                <ul>
                    <li>급여 외 식대 지원</li>
                    <li>자기계발비 지원</li>
                    <li>유연근무제 시행</li>
                    <li>연차 자유 사용</li>
                    <li>건강검진 및 의료비 지원</li>
                </ul>
            </div>

            <div class="job-info-box">
                <div>
                    <h2>경력</h2>
                  <p th:text="${jDto.expLevel}">경력</p>

                </div>
                <div>
                    <h2>학력</h2>
                    <p>무관</p>
                </div>
                <div>
                    <h2>마감일</h2>
                    <p th:text="${jDto.postingEndDt}">마감일</p>

                </div>
                <div>
                    <h2>근무지</h2>
                   <p th:text="${jDto.roadAddress}">근무주소<p>

                </div>
                <div>
                    <h2>급여</h2>
                    <p>3,000~4,500만원</p>
                </div>
                <div>
                    <h2>근무형태</h2>
                    <p>정규직</p>
                </div>
            </div>

            <div class="company-intro">
                <h2 style="font-size: 30px; margin-bottom: 20px;"  th:utext="${jDto.corpInfo}"><strong>기업소개</strong></h2>
                <img src="" class="company-image" />
                <div class="company-description">
                    저희 테크노베이션은 혁신적인 기술과 창의적인 아이디어로 디지털 혁신을 이끌어가는 IT 기업입니다. 
                    2021년 설립 이후 지속적인 성장을 이어가고 있으며, 고객의 니즈를 정확히 파악하고 최적의 솔루션을 제공하기 위해 끊임없이 노력하고 있습니다.
                    <br><br>
                    직원들의 성장과 발전을 위한 다양한 프로그램을 운영하며, 자유롭고 수평적인 조직문화를 추구합니다. 
                    개발자들이 최고의 퍼포먼스를 발휘할 수 있도록 최신 개발 환경과 도구를 제공하고 있으며, 
                    지속적인 학습과 성장을 지원하는 교육 프로그램도 운영하고 있습니다.
                    <br><br>
                    함께 성장하며 더 나은 미래를 만들어갈 동료를 찾고 있습니다.
                </div>
            </div>
        </div>
    </div>

    <!-- 플로팅 사이드바 -->
    <div class="floating-sidebar">
        <div class="company-floating-card">
            <div class="company-logo-section">
                <div class="logo-placeholder">
                    <span>🏢</span>
                </div>
                <div class="company-title">
                    <h4 th:text="${jDto.corpNm}">기업이름</h4>
                    <span><a th:href="@{/user/job_posting/company_info}">기업정보 보기 &gt;</a></span>
                </div>
            </div>

            <div class="company-info-section">
                <div class="info-item">
                    <span class="label">업력</span>
                    <span class="value">5년차 (2021년 설립)</span>
                </div>
            </div>

            <button class="floating-apply-btn" id="applyBtn">지원하기</button>

            <div class="floating-actions">
                <button class="floating-action-btn" id="scrapBtn">
                    <span class="icon" id="heartIcon">🤍</span>
                    <span class="text">스크랩</span>
                </button>
            </div>
        </div>
    </div>

<!-- 모달창 -->
 <div id="applyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>입사지원</h2>
                <span class="close-btn" id="closeBtn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="job-info">
                    <div class="job-title">서버 백엔드 개발자</div>
                    <div class="job-company">팩션엔스업컴퍼니</div>
                </div>

                <div class="section-title">통합 계정정보</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">이름</span>
                        <span class="info-value">유연수</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">이메일</span>
                        <span class="info-value">yeonsu0108@naver.com</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">연락처</span>
                        <span class="info-value">010-2912-9954</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">출생년도</span>
                        <span class="info-value">2002</span>
                    </div>
                </div>

                <div class="section-title">지원 이력서 <span class="required">●</span></div>
                <div class="resume-section">
                    <div class="resume-item">
                        <input type="radio" id="resume1" name="selectedResume" value="resume1" class="resume-radio" checked>
                        <label for="resume1" class="resume-label">
                            <div class="resume-icon"></div>
                            <div class="resume-info">
                                <div class="resume-title">유연수 이력서입니다</div>
                                <div class="resume-meta">2025.06.15 등록</div>
                                <div class="resume-tags">
                                    <span class="tag">기술스택</span>
                                    <span class="tag">학력</span>
                                    <span class="tag">경력/프로젝트</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="resume-item">
                        <input type="radio" id="resume2" name="selectedResume" value="resume2" class="resume-radio">
                        <label for="resume2" class="resume-label">
                            <div class="resume-icon"></div>
                            <div class="resume-info">
                                <div class="resume-title">백엔드 개발자 포트폴리오</div>
                                <div class="resume-meta">2025.05.20 등록</div>
                                <div class="resume-tags">
                                    <span class="tag">Spring Boot</span>
                                    <span class="tag">MySQL</span>
                                    <span class="tag">AWS</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="resume-item">
                        <input type="radio" id="resume3" name="selectedResume" value="resume3" class="resume-radio">
                        <label for="resume3" class="resume-label">
                            <div class="resume-icon"></div>
                            <div class="resume-info">
                                <div class="resume-title">신입 개발자 이력서</div>
                                <div class="resume-meta">2025.04.10 등록</div>
                                <div class="resume-tags">
                                    <span class="tag">Java</span>
                                    <span class="tag">프로젝트 경험</span>
                                    <span class="tag">대학 전공</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="section-title">첨부 파일</div>
                <div class="attachment-section">
                    <div class="file-upload-area" id="uploadArea">
                        <div class="upload-icon">📎</div>
                        <div class="upload-text">같이 제출하실 추가 파일을 업로드해주세요</div>
                        <div class="upload-subtext">PDF 참부를 추천드려요!</div>
                        <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.txt">
                    </div>
                    <div class="uploaded-files" id="uploadedFiles"></div>
                </div>

           
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel-btn" id="cancelBtn">취소</button>
                <button class="modal-apply-btn" id="confirmBtn">지원하기</button>
            </div>
        </div>
    </div>

</main>
<footer>
<div th:replace="~{fragments/footer :: footer}"></div>
</footer>
</body>
</html>
