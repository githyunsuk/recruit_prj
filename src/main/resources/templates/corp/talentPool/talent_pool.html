<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인재 관리</title>
    <th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
    <link rel="stylesheet" th:href="@{/corp/talentPool/talent_pool.css}" />
    <link rel="stylesheet" th:href="@{/corp/talentPool/interviewOffer.css}"/>
  <style>

</style>
</head>
<body>
    <th:block th:replace="~{fragments/corpHeader :: corpHeader}"></th:block>
    <div class="container">
	<th:block th:replace="~{fragments/talentPoolHeader :: talentPoolHeader(activeTab='talent_pool')}"></th:block>
        
		<div class="search-toolbar">
		    <div class="list-totalcount">
		        전체 <span th:text="${totalCount}"></span>건
		    </div>
		    <div class="sort-controls">
		        <span>최신순</span>|
		        <span>경력순</span>
				<select class="page-size-select" name="size" id="pageSizeSelect">
				    <option value="5" th:selected="${pageSize == 5}">5명씩</option>
				    <option value="10" th:selected="${pageSize == 10}">10명씩</option>
				    <option value="20" th:selected="${pageSize == 20}">20명씩</option>
				</select>
		    </div>
		</div>
	
        <div class="talent-list">
            <div class="talent-item" th:each="talent : ${ talentPool }">
                <div class="talent-left">
                    <div class="talent-profile" th:text="${ talent.name }"></div>
                    <div class="talent-info" 
                    th:text="|${talent.gender == 'M' ? '남' : (talent.gender == 'F' ? '여' : '기타')}
                    ·${ talent.birthYear }년생|"></div>
                </div> 
                
                <div class="talent-right">
                    <div class="spec-grid">
                        <div class="spec-title">최종학력</div>
                        <div th:text="${ talent.finalEducation }"><!-- 대학교 졸업 --></div>
                        <div class="spec-title">경력</div>
                        <div th:text="${ talent.totalCareer }"><!-- 경력 4년차 --></div>
                        <div class="spec-title">거주지</div>
                        <div th:text="${ talent.shortAddress }"><!-- 서울 --></div>
                        <div class="spec-title">자격증</div>
                        <div th:text="${ talent.certifications }"><!-- 정보처리기사 --></div>
                        <div class="spec-title">기술 스택</div>
                        <div class="skill-tags">
                            <span class="skill-tag" th:text="${ talent.techStacks }"><!-- Docker --></span>
                        </div>
                     	<div class="spec-title">희망 직종</div>
                        <div class="skill-tags">
                            <span class="skill-tag" th:text="${ talent.desiredPositions }">Docker</span>
                        </div> 
                    </div>
                </div>
        
                <div class="talent-actions">
					<button class="action-btn bookmark-btn"
			        th:data-resume-seq="${talent.resumeSeq}"
			        th:data-corp-no="${talent.corpNo}">
		    		<span class="bookmark-star" 
			      	th:classappend="${talent.isScrapped == 'Y'} ? 'filled'" 
			      	th:text="${talent.isScrapped == 'Y'} ? '★' : '☆'"></span>스크랩
					</button>
                    <a th:href="@{/corp/talentPool/resume_detail}">
                    <button class="action-btn resume-btn">이력서 확인</button></a>
                    <button class="action-btn interview-btn openInterviewModalBtn">
                    면접 제안</button>
                </div>
            </div>
        	</div>
        </div>
<div class="modal" id="interviewModal" style="display:none;"></div>
			
<div class="pagination">
  <a href="#" class="page-btn prev-block">이전</a>
  <span class="page-numbers"></span>
  <a href="#" class="page-btn next-block">다음</a>
</div>
<div id="pagination-data"
     th:data-total-pages="${totalPages}"
     th:data-current-page="${page}">
</div>

<script th:inline="javascript">
(() => {
	const dataEl = document.getElementById('pagination-data');
	const totalPages = parseInt(dataEl.dataset.totalPages);
	let currentPage = parseInt(dataEl.dataset.currentPage);

  /** ------------------ 페이징 ------------------ **/
  const pagination = document.querySelector('.pagination');
  if (pagination && totalPages > 1) {
    const prevBlockBtn = pagination.querySelector('.prev-block');
    const nextBlockBtn = pagination.querySelector('.next-block');
    const pageNumbersContainer = pagination.querySelector('.page-numbers');
    const blockSize = 5;
    let currentBlock = Math.floor((currentPage - 1) / blockSize);
    const totalBlocks = Math.ceil(totalPages / blockSize);

    function renderPageNumbers() {
      pageNumbersContainer.innerHTML = '';
      const startPage = currentBlock * blockSize + 1;
      const endPage = Math.min(startPage + blockSize - 1, totalPages);

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('a');
        btn.href = '#';
        btn.className = 'page-btn';
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          goToPage(i);
        });
        pageNumbersContainer.appendChild(btn);
      }

      prevBlockBtn.classList.toggle('disabled', currentBlock === 0);
      nextBlockBtn.classList.toggle('disabled', currentBlock >= totalBlocks - 1);
    }

    function goToPage(page) {
      const url = new URL(window.location.href);
      url.searchParams.set('page', page);
      window.location.href = url.toString();
    }

    prevBlockBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentBlock > 0) {
        currentBlock--;
        goToPage(currentBlock * blockSize + 1);
      } else if (currentPage > 1) {
        goToPage(currentPage - 1);
      }
    });

    nextBlockBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentBlock < totalBlocks - 1) {
        currentBlock++;
        goToPage(currentBlock * blockSize + 1);
      } else if (currentPage < totalPages) {
        goToPage(currentPage + 1);
      }
    });

    renderPageNumbers();
  }

  /** ------------------ 페이지 사이즈 변경 ------------------ **/
  const sizeSelect = document.getElementById('pageSizeSelect');
  if (sizeSelect) {
    sizeSelect.addEventListener('change', function () {
      const size = this.value;
      const url = new URL(window.location);
      url.searchParams.set('size', size);
      url.searchParams.set('page', 1);
      window.location.href = url.toString();
    });
  }

  /** ------------------ 스크랩 버튼 ------------------ **/
  document.querySelectorAll('.bookmark-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const resumeSeq = this.dataset.resumeSeq;
      const star = this.querySelector('.bookmark-star');

      fetch('/corp/talentPool/scrap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ resumeSeq })
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'scrap_success') {
            star.textContent = '★';
            star.classList.add('filled');
          } else if (data.status === 'scrap_cancel') {
            star.textContent = '☆';
            star.classList.remove('filled');
          } else {
            alert('스크랩 실패: ' + data.status);
          }
        })
        .catch(err => {
          console.error('스크랩 실패', err);
          alert('스크랩 실패');
        });
    });
  });

  /** ------------------ 모달 ------------------ **/
  document.querySelectorAll('.openInterviewModalBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      fetch('/corp/talentPool/interviewOffer')
        .then(response => response.text())
        .then(html => {
          const modal = document.getElementById('interviewModal');
          if (modal) {
            modal.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
          }
        });
    });
  });

  function closeModal() {
    const modal = document.getElementById('interviewModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  }

  window.addEventListener('click', function (event) {
    const modal = document.getElementById('interviewModal');
    if (event.target === modal) closeModal();
  });

  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') closeModal();
  });

})();
</script>
	<th:block th:replace="~{fragments/corpFooter :: corpFooter}"></th:block>
</body>
</html>