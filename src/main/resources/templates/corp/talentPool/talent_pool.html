<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인재 관리</title>
    <th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
    <link rel="stylesheet" th:href="@{/corp/talentPool/talent_pool.css}" />
    <link rel="stylesheet" th:href="@{/corp/talentPool/interviewOffer.css}"/>
  <style>

</style>
</head>
<body>
    <th:block th:replace="~{fragments/corpHeader :: corpHeader}"></th:block>
    <div class="container">
	<th:block th:replace="~{fragments/talentPoolHeader :: talentPoolHeader(activeTab='talent_pool')}"></th:block>
        
		<div class="search-toolbar">
		    <div class="list-totalcount">
		        전체 <span th:text="${totalCount}"></span>건
		    </div>
		    <div class="sort-controls">
			  <span class="sort-btn" data-sort="latest">최신순</span> |
			  <span class="sort-btn" data-sort="career">경력순 <span class="arrow"></span></span> |
			  <span class="sort-btn" data-sort="education">학력순 <span class="arrow"></span></span>
				<select class="page-size-select" name="size" id="pageSizeSelect">
				    <option value="5" th:selected="${pageSize == 5}">5명씩</option>
				    <option value="10" th:selected="${pageSize == 10}">10명씩</option>
				    <option value="20" th:selected="${pageSize == 20}">20명씩</option>
				</select>
		    </div>
		</div>
       	<div class="talent-list" th:replace="~{fragments/talentList :: talentList}"></div>
     </div> 
<div class="modal" id="interviewModal" style="display:none;"></div>
			
<div class="pagination">
  <a href="#" class="page-btn prev-block">이전</a>
  <span class="page-numbers"></span>
  <a href="#" class="page-btn next-block">다음</a>
</div>
<div id="pagination-data"
     th:data-total-pages="${totalPages}"
     th:data-current-page="${page}">
</div>

<script th:inline="javascript">
(() => {
	  let currentPage = parseInt(document.getElementById('pagination-data')?.dataset.currentPage || '1');
	  let totalPages = parseInt(document.getElementById('pagination-data')?.dataset.totalPages || '1');
	  let currentSortBy = 'latest';
	  let currentOrder = 'desc';
	  let currentSize = parseInt(document.getElementById('pageSizeSelect')?.value || '5');
	  const blockSize = 5;

	  //목록 로딩
	  function loadTalentList(page = 1) {
	    const pageSizeSelect = document.getElementById('pageSizeSelect');
	    const talentListEl = document.querySelector('.talent-list');

	    let size = pageSizeSelect?.value || '5';

	    fetch(`/sort?page=${page}&size=${size}&sortBy=${currentSortBy}&order=${currentOrder}`)
	      .then(res => res.text())
	      .then(html => {
	        if (!talentListEl) return;
	        talentListEl.innerHTML = html;

	        currentPage = page;
	        currentSize = parseInt(size);

	        bindListEvents();
	        renderPagination();
	      })
	      .catch(err => console.error('목록 로딩 실패:', err));
	  }

	  //페이지네이션 렌더링
	  function renderPagination() {
	    const paginationContainer = document.querySelector('.page-numbers');
	    const prevBlockBtn = document.querySelector('.prev-block');
	    const nextBlockBtn = document.querySelector('.next-block');

	    if (!paginationContainer) return;
	    paginationContainer.innerHTML = '';

	    const currentBlock = Math.floor((currentPage - 1) / blockSize);
	    const startPage = currentBlock * blockSize + 1;
	    const endPage = Math.min(startPage + blockSize - 1, totalPages);

	    for (let i = startPage; i <= endPage; i++) {
	      const btn = document.createElement('a');
	      btn.href = '#';
	      btn.textContent = i;
	      btn.className = 'page-btn';
	      if (i === currentPage) btn.classList.add('active');
	      btn.addEventListener('click', e => {
	        e.preventDefault();
	        loadTalentList(i);
	      });
	      paginationContainer.appendChild(btn);
	    }

	    if (prevBlockBtn) {
	      prevBlockBtn.onclick = e => {
	        e.preventDefault();
	        if (startPage > 1) loadTalentList(startPage - 1);
	      };
	    }
	    if (nextBlockBtn) {
	      nextBlockBtn.onclick = e => {
	        e.preventDefault();
	        if (endPage < totalPages) loadTalentList(endPage + 1);
	      };
	    }
	  }

	  //정렬 관련
	  const sortButtons = document.querySelectorAll('.sort-btn');

	  function getSortText(sortBy, order) {
	    const baseText = {
	      latest: '최신순',
	      career: '경력순',
	      education: '학력순',
	    };
	    if (!order || sortBy === 'latest') return baseText[sortBy];
	    return `${baseText[sortBy]} ${order === 'desc' ? '↓' : '↑'}`;
	  }

	  function bindSortEvents() {
	    sortButtons.forEach(btn => {
	      btn.addEventListener('click', () => {
	        const clickedSortBy = btn.dataset.sort;
	        if (!clickedSortBy) return;

	        if (clickedSortBy === 'latest') {
	          currentSortBy = 'latest';
	          currentOrder = 'desc';
	        } else {
	          if (currentSortBy === clickedSortBy) {
	            currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
	          } else {
	            currentSortBy = clickedSortBy;
	            currentOrder = 'asc';
	          }
	        }

	        sortButtons.forEach(b => {
	          b.classList.remove('active');
	          b.innerText = getSortText(b.dataset.sort, null);
	        });

	        btn.classList.add('active');
	        btn.innerText = getSortText(clickedSortBy, currentOrder);

	        loadTalentList(1);
	      });
	    });
	  }

	  //페이지 사이즈 변경 
	  const pageSizeSelect = document.getElementById('pageSizeSelect');
	  function bindPageSizeChange() {
	    if (!pageSizeSelect) return;
	    pageSizeSelect.addEventListener('change', e => {
	      currentSize = parseInt(e.target.value);
	      loadTalentList(1);
	    });
	  }

	  //동적 목록 이벤트 바인딩 
	  function bindListEvents() {
	    const talentListEl = document.querySelector('.talent-list');
	    const modalEl = document.getElementById('interviewModal');
	    if (!talentListEl) return;

	    // 스크랩 버튼
	    talentListEl.querySelectorAll('.bookmark-btn').forEach(btn => {
	      btn.onclick = () => {
	        const resumeSeq = btn.dataset.resumeSeq;
	        const star = btn.querySelector('.bookmark-star');
	        if (!resumeSeq || !star) return;

	        fetch('/corp/talentPool/scrap', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ resumeSeq }),
	        })
	          .then(res => res.json())
	          .then(data => {
	            if (data.status === 'scrap_success') {
	              star.textContent = '★';
	              star.classList.add('filled');
	            } else if (data.status === 'scrap_cancel') {
	              star.textContent = '☆';
	              star.classList.remove('filled');
	            } else {
	              alert('스크랩 실패: ' + data.status);
	            }
	          })
	          .catch(() => alert('스크랩 실패'));
	      };
	    });

	    // 면접 제안 모달 버튼
	    talentListEl.querySelectorAll('.openInterviewModalBtn').forEach(btn => {
	      btn.onclick = () => {
	        fetch('/corp/talentPool/interviewOffer')
	          .then(res => res.text())
	          .then(html => {
	            if (!modalEl) return;
	            modalEl.innerHTML = html;
	            modalEl.style.display = 'block';
	            document.body.style.overflow = 'hidden';

	            const closeBtn = modalEl.querySelector('.modal-close');
	            if (closeBtn) closeBtn.onclick = closeModal;
	          })
	          .catch(() => alert('면접 제안 모달 로딩 실패'));
	      };
	    });
	  }

	  // 모달 닫기
	  function closeModal() {
	    const modalEl = document.getElementById('interviewModal');
	    if (!modalEl) return;
	    modalEl.style.display = 'none';
	    modalEl.innerHTML = '';
	    document.body.style.overflow = 'auto';
	  }

	  function bindModalClose() {
	    document.addEventListener('keydown', e => {
	      if (e.key === 'Escape') closeModal();
	    });
	  }

	  //초기 실행
	  bindSortEvents();
	  bindPageSizeChange();
	  bindModalClose();
	  loadTalentList(currentPage);
	  renderPagination();
	})();

</script>


	<th:block th:replace="~{fragments/corpFooter :: corpFooter}"></th:block>
</body>
</html>